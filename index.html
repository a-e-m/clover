<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
        <title>üçÄClover</title>
        <style>
            :root {
                --rows: 3;
                --columns: 2;
                --card-size: min(calc(60vh / var(--rows)), calc(80vw / var(--columns)));
                --gray: #444;
                --yellow: #b5933b;
                --green: #114611;
                --red: #671212;
                --greenSelected: #185e18;
                --redSelected: #971a1a;
                --selected: #666;
                --background: #121213;
                --text-color: #eeeeee;
                --word-offset: calc(var(--card-size) / 2.4);
            }

            body {
                touch-action: manipulation;
                color: var(--text-color);
                background-color: var(--background);
                text-align: center;
                font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
                display: flex;
                flex-direction: column;
                justify-content: space-evenly;
                align-items: center;
                padding-top: 1vh;
                height: 90vh;
                margin: 0;
            }
            h1 {
                margin: 0;
                font-size: 4vh;
                font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
            }
            @keyframes buttonpress {
                from {
                    opacity: 0.8;
                }
                50% {
                    opacity: 0.8;
                    opacity: 1;
                }
                to {
                    opacity: 1;
                }
            }
            button {
                background-color: gray;
                color: white;
                border: none;
                font-size: var(--key-size);
                box-sizing: border-box;
            }
            @media (pointer: fine) {
                button:hover {
                    background-color: rgb(150, 150, 150);
                }
            }
            button:active {
                animation: buttonpress 0.5s;
            }
            button:disabled {
                background-color: var(--gray);
            }
            @keyframes fadein {
                from {
                    display: flex;
                    opacity: 0;
                }

                50% {
                    opacity: 0;
                }

                to {
                    opacity: 1;
                }
            }

            .result-container {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;
                display: none;
                background-color: rgba(0, 0, 0, 0.6);
            }

            .result-container.done {
                animation: fadein 0.5s;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .results {
                font-size: calc(var(--letter-size) * 0.25);
                background-color: var(--background);
                border: 0.5vmin solid black;
                padding: 10vh;
            }
 
            .card {
                width: var(--card-size);
                height: var(--card-size);
                background-color: var(--gray);
                position: relative;
                display: flex;
                justify-content: center;
                align-items: center;
                margin: calc(var(--card-size) * 0.05);
                touch-action: manipulation;
                -webkit-user-select: none;  
                -moz-user-select: none;    
                -ms-user-select: none;      
                user-select: none;
                transition: transform 0.8s ease-in-out;
                top: 0;
                left: 0;
            }

            .card.animated {
                transition: transform 0.8s ease-in-out, left 0.5s, top 0.5s;
            }

            .card .word {
                position: absolute;
            }

            .card :nth-child(1) {
                transform: rotate(0deg) translate(0px, var(--word-offset));
            }

            .card :nth-child(2) {
                transform: rotate(90deg) translate(0px, var(--word-offset));
            }

            .card :nth-child(3) {
                transform: rotate(180deg) translate(0px, var(--word-offset));
            }

            .card :nth-child(4) {
                transform: rotate(270deg) translate(0px, var(--word-offset));
            }

            .play-container {
                position: relative;
            }

            .card-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 1fr 1fr;
                position: relative;
                transition: transform 1s ease-in-out;
                transform: rotate(var(--card-container-rotation));
            }

            .word-entry {
                border-bottom: 10px solid var(--green);
                padding-bottom: 10px;
                border-radius: 20px;
            }

            .card-1 {
                transform: rotate(var(--card-1-rotation));
            }

            .card-2 {
                transform: rotate(var(--card-2-rotation));
            }

            .card-3 {
                transform: rotate(var(--card-3-rotation));
            }

            .card-4 {
                transform: rotate(var(--card-4-rotation));
            }

            .card-5 {
                transform: rotate(var(--card-5-rotation));
            }

            .play-container > .card {
                margin: calc(var(--card-size) * 0.1) auto;
            }

            .spinner {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }

            .spin-button {
                width: 50px;
                height: 50px;
                border-radius: 25px;
                z-index: 100;
            }

            .answer-container {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: center;
            }

            .word-entry::after {
                font-size: 30px;
                color: var(--green);
                margin-top: -25px;
                content: "‚áì";
                position: absolute;
                transform: translate(-50%, 75%);
                z-index: -1;
            }

            .answer {
                position: absolute;
                text-shadow: 1px 1px 2px var(--background);
            }

            .answer-1 {
                bottom: 0;
                left: 50%;
                transform: translate(-50%, 50%);
            }

            .answer-2 {
                top: 50%;
                right: 0;
                transform: translate(50%, -50%) rotate(270deg);
            }

            .answer-3 {
                left: 50%;
                transform: translate(-50%, -50%) rotate(180deg);
            }

            .answer-4 {
                top: 50%;
                transform: translate(-50%, -50%) rotate(90deg);
            }

            .answer-button {
                border-radius: 0.2vh;
                margin: 1vh;
            }

            .hidden {
                display: none;
            }

            .focused {
                background-color: var(--selected);
            }

            .correct {
                background-color: var(--green);
            }

            .correct::after {
                content: "‚óØ"
            }

            .focused.correct {
                background-color: var(--greenSelected);
            }

            .wrong {
                background-color: var(--red);
            }

            .wrong::after {
                content: "‚úò"
            }

            .focused.wrong {
                background-color: var(--redSelected);
            }
        </style>
        <script>
            const cards = [["stylist", "pyramid", "club", "loop"], ["broom", "tradition", "bronze", "saber"], ["lazy", "stocks", "crane", "district"], ["luxury", "battery", "carpet", "laugh"], ["flame", "sleeve", "architecture", "family"], ["shark", "feed", "ear", "cavern"], ["double", "silence", "air", "police"], ["closet", "rain", "asset", "race"], ["military", "dinosaur", "birthday", "press"], ["Africa", "liquid", "twins", "patio"], ["mind", "moon", "hide", "casino"], ["game", "canvas", "punch", "soup"], ["dance", "prison", "matter", "crown"], ["lock", "schedule", "guitar", "thermometer"], ["distributor", "plush", "archeology", "cork"], ["canal", "wheat", "museum", "roof"], ["Asia", "glove", "shape", "ground"], ["hell", "track", "milk", "taste"], ["smoke", "needle", "knot", "butcher"], ["book", "soft", "poison", "diamond"], ["America", "wand", "pigeon", "robot"], ["button", "union", "axe", "board"], ["light", "case", "pepper", "fast"], ["hard", "kitchen", "finger", "note"], ["ball", "night", "tree", "school"], ["reptile", "major", "dead", "radar"], ["donkey", "virgin", "mug", "pork"], ["clothing", "banana", "tattoo", "doe"], ["chocolate", "office", "pair", "protect"], ["tent", "noodle", "weapon", "bakery"], ["fountain", "ice", "walk", "chick"], ["genius", "jewel", "summit", "bug"], ["log", "master", "skin", "border"], ["plank", "oasis", "cereal", "evening"], ["toy", "basket", "weak", "knight"], ["mummy", "flight", "bread", "chess"], ["forecast", "screw", "tomato", "grey"], ["foam", "handle", "talent", "vegetable"], ["major", "dead", "radar", "reptile"], ["frame", "weight", "pumpkin", "jungle"], ["marker", "technology", "edge", "beer"], ["diet", "explosion", "tap", "show"], ["deep", "region", "cemetery", "bracelet"], ["old", "tiger", "alliance", "cabin"], ["leak", "flask", "target", "marriage"], ["revenge", "watch", "motor", "heel"], ["ray", "boot", "rat", "gate"], ["detergent", "castle", "frost", "plastic"], ["foot", "winter", "high", "island"], ["cow", "circle", "sock", "door"], ["metal", "lighthouse", "emergency", "hero"], ["curtain", "charge", "Antarctica", "armor"], ["essence", "joke", "hospital", "roast"], ["building", "boxing", "first", "fever"], ["award", "fly", "calendar", "skull"], ["eye", "sea", "bouquet", "box"], ["Europe", "repair", "victory", "dragon"], ["cactus", "bulb", "cake", "princess"], ["trailer", "decor", "recipe", "blond"], ["cream", "laser", "arm", "work"], ["grain", "shed", "turtle", "statue"], ["beach", "morning", "head", "machine"], ["champion", "permanent", "cannon", "potato"], ["exit", "plant", "candle", "antiquity"], ["console", "voice", "recipient", "cell"], ["rice", "balcony", "bag", "thing"], ["short", "drink", "horse", "polar"], ["green", "pie", "cage", "bump"], ["theater", "smell", "oar", "thief"], ["chimney", "clean", "story", "jar"], ["dog", "ramp", "television", "lemon"], ["ammo", "vacation", "rose", "volume"], ["end", "commerce", "trophy", "shovel"], ["tube", "berry", "electricity", "spy"], ["snake", "Belgium", "sharp", "carton"], ["ladybug", "restaurant", "painting", "speaker"], ["syrup", "king", "place", "glasses"], ["plane", "nut", "bath", "nerve"], ["flour", "soil", "charm", "tame"], ["beard", "north", "bottle", "group"], ["honey", "desert", "paper", "virus"], ["iron", "whirlwind", "wine", "boat"], ["stick", "country", "secret", "cigarette"], ["snail", "dynamite", "pliers", "slide"], ["animal", "map", "waiter", "foot"], ["storm", "pod", "soldier", "ghost"], ["nude", "well", "rooster", "alcohol"], ["comforter", "brown", "covered", "furniture"], ["bank", "lava", "dessert", "god"], ["library", "bomb", "food", "gift"], ["toilet", "earth", "mouse", "yellow"], ["blade", "peace", "bowl", "mouth"], ["cockroach", "landscape", "champagne", "Switzerland"], ["stitches", "garden", "spear", "ink"], ["studio", "cave", "mosquito", "magician"], ["spring", "band", "bone", "marine"], ["humor", "garbage", "car", "small"], ["train", "bear", "solitary", "grave"], ["hole", "march", "wood", "skeleton"], ["rifle", "post", "boss", "color"], ["bed", "zoo", "angel", "key"], ["leaf", "career", "swing", "bottom"], ["cushion", "necklace", "oil", "vampire"], ["caterpillar", "bar", "strong", "knife"], ["melon", "lake", "sound", "gold"], ["heavy", "tea", "room", "life"], ["feather", "pan", "orange", "tiny"], ["wind", "China", "belt", "bark"], ["wheel", "balance", "universe", "chameleon"], ["mass", "photo", "orchard", "performance"], ["pearl", "carrot", "lady", "blanket"], ["fuel", "look", "roll", "hook"], ["layer", "devil", "mint", "recent"], ["basement", "sun", "concert", "cable"], ["newspaper", "bug", "egg", "nail"], ["chain", "cold", "advocate", "fur"], ["comedy", "pocket", "suite", "missile"], ["handicap", "lion", "rich", "star"], ["spicy", "hat", "large", "pine"], ["hearing", "ladle", "hearth", "stage"], ["field", "flute", "crab", "passion"], ["sight", "base", "subway", "baby"], ["mobile", "oak", "raft", "suspect"], ["cheese", "illness", "column", "cloud"], ["glass", "turn", "hobbies", "series"], ["judge", "herbs", "dresser", "suitcase"], ["month", "stroke", "cabbage", "stunt"], ["space", "accessory", "brain", "alarm"], ["oven", "entry", "round", "sand"], ["phone", "music", "cantina", "lightning"], ["perfume", "chariot", "napkin", "limb"], ["museum", "wheat", "roof", "canal"], ["surgeon", "silver", "menu", "pizza"], ["jump", "cinema", "cup", "dream"], ["snow", "palace", "wing", "scissors"], ["couch", "helmet", "farm", "strength"], ["whip", "uniform", "human", "window"], ["hammer", "forbidden", "drawing", "bin"], ["pig", "rail", "sage", "trade"], ["rifle", "boss", "post", "color"], ["sport", "airport", "currency", "mirage"], ["stud", "bench", "camera", "patron"], ["business", "myth", "big", "dish"], ["feline", "clown", "garage", "tobacco"], ["barn", "explore", "giant", "tower"], ["fry", "ruler", "revolution", "mail"], ["fish", "inside", "astronaut", "padlock"], ["attic", "dough", "water", "queen"], ["beef", "mark", "chair", "doctor"], ["puzzle", "stone", "cougar", "coffee"], ["degree", "siren", "cube", "apron"], ["internet", "father", "snack", "captain"], ["wizard", "rake", "tongue", "attraction"], ["young", "ocean", "camouflage", "salad"], ["root", "screen", "beast", "volcano"], ["mushroom", "truck", "church", "table"], ["history", "day", "shield", "inspection"], ["sweet", "nest", "bubble", "poetry"], ["exhibition", "ship", "apple", "common"], ["mud", "grenade", "trash", "claw"], ["letter", "safari", "sewer", "engine"], ["hair", "tool", "hall", "heroine"], ["microscope", "report", "string", "blood"], ["file", "magnet", "tennis", "shop"], ["science", "cross", "hot", "dwarf"], ["branch", "quilt", "soap", "full"], ["fashion", "movie", "tile", "bite"], ["bang", "owl", "ruin", "stamp"], ["gas", "appetite", "war", "heart"]];

            function withId(id) {
                return document.getElementById(id);
            }

            function el(tag, text, className) {
                const element = document.createElement(tag);
                if (text) {
                    const textEl = document.createTextNode(text);
                    element.appendChild(textEl);
                }
                if (className) {
                    element.className = className;
                }
                return element;
            }

            function getRandomInt(min, max) {
                min = Math.ceil(min);
                max = Math.floor(max);
                // The maximum is exclusive and the minimum is inclusive
                return Math.floor(Math.random() * (max - min) + min);
            }

            function randomChoice(list) {
                const index = getRandomInt(0, list.length);
                return [list[index], index];
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            function randomCard(alreadySeen) {
                const [card, index] = randomChoice(cards);
                if (alreadySeen && alreadySeen.has(index)) {
                    return randomCard(alreadySeen);
                }
                return [card, index];
            }

            function fallbackCopyTextToClipboard(text) {
                var textArea = document.createElement("textarea");
                textArea.value = text;
                
                // Avoid scrolling to bottom
                textArea.style.top = "0";
                textArea.style.left = "0";
                textArea.style.position = "fixed";

                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    var successful = document.execCommand('copy');
                    var msg = successful ? 'successful' : 'unsuccessful';
                    console.log('Fallback: Copying text command was ' + msg);
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                }

                document.body.removeChild(textArea);
            }

            function copyTextToClipboard(text) {
                if (!navigator.clipboard) {
                    fallbackCopyTextToClipboard(text);
                    return;
                }
                navigator.clipboard.writeText(text).then(function() {
                    console.log('Async: Copying to clipboard was successful!');
                }, function(err) {
                    console.error('Async: Could not copy text: ', err);
                });
            }

            function setStyleVar(name, value) {
                document.documentElement.style.setProperty(`--${name}`, value);
            }

            function getCardHash(cardObj) {
                return cyrb53([cardObj.listIndex, cardObj.index, (cardObj.rotation % 360)].join('-'));
            }

            function getAnswerString(answers, currentCards) {
                cardsCopy = [...currentCards];
                shuffleArray(cardsCopy);
                const result = {
                    answers: answers.map(obj => obj.answer),
                    cards: cardsCopy.map(obj => [obj.index, getCardHash(obj)].join('|'))

                };
                const [extraCard, extraCardIndex] = randomCard();
                result.cards.push(extraCardIndex);
                return new URLSearchParams(result).toString();
            }

            function resultsPopup(answers, currentCards) {
                const resultsUrl = window.location.origin + "/clover?" + getAnswerString(answers, currentCards);
                withId('result-container').className += ' done';
                withId('result-text').innerText = resultsUrl;
                const copyButton = withId('copy-button');
                copyButton.addEventListener('click', () => {
                    copyTextToClipboard(resultsUrl);
                    withId('result-container').className = 'result-container';
                });
                const exitButton = withId('exit-button');
                exitButton.addEventListener('click', () => {
                    withId('result-container').className = 'result-container';
                });
            }

            function updateClasses(obj) {
                obj.el.className = obj.classes.join(" ");
            }

            function rotate(cardObj, rotation) {
                if (rotation !== undefined) {
                    cardObj.rotation += rotation;
                } else {
                    cardObj.rotation = cardObj.rotation + 90;
                }
                cardObj.classes.length = 1;
                cardObj.classes.push("rotate-" + cardObj.rotation);
                cardObj.classes.push(`${cardObj.stylePrefix}`);
                if (cardObj.listIndex !== undefined) {
                    cardObj.el.style.order = cardObj.listIndex;
                }
                updateClasses(cardObj);
                setStyleVar(`${cardObj.stylePrefix}-rotation`, `${cardObj.rotation}deg`);
                withId("answer-input").value = "";
            }

            // from https://stackoverflow.com/questions/7616461/generate-a-hash-from-string-in-javascript
            const cyrb53 = function (str, seed = 0) {
                let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
                for (let i = 0, ch; i < str.length; i++) {
                    ch = str.charCodeAt(i);
                    h1 = Math.imul(h1 ^ ch, 2654435761);
                    h2 = Math.imul(h2 ^ ch, 1597334677);
                }
                h1 = Math.imul(h1 ^ (h1>>>16), 2246822507) ^ Math.imul(h2 ^ (h2>>>13), 3266489909);
                h2 = Math.imul(h2 ^ (h2>>>16), 2246822507) ^ Math.imul(h1 ^ (h1>>>13), 3266489909);
                return (h2>>>0).toString(16).padStart(8,0) + (h1>>>0).toString(16).padStart(8,0);
            };
        </script>
    </head>
    <body>
        <div>
            <h1 id="title">üçÄClover</h1>
            <a href="./instructions.html">Instructions</a>
            <a href="./">Reset</a>
        </div>
        <div id="play-container" class="play-container">
            <div id="card-container" class="card-container"></div>
        </div>
        <div id="answer-container" class="answer-container">
            <form id="word-form" class="answer-form">
                <input name="answer" id="answer-input" placeholder="Enter word" type="text"></input>
                <button id="answer-button" class="answer-button" type="submit">Enter</button>
            </form>
            <div id="check-form" class="check-form">
                <button id="check-button" class="check-button">Check</button>
            </div>
        </div>
        <div id="result-container" class="result-container">
            <div id="results" class="results">
                <div id="result-text">

                </div>
                <button id="copy-button" class="copy-button">Copy Results</button>
                <button id="exit-button" class="exit-button">Close</button>
            </div>
        </div>
        <script>
            let answers = [{}, {}, {}, {}];
            let startingCards = [];
            const currentCards = [];
            const hashes = new Set();
            const queryParams = new URLSearchParams(window.location.search);
            const wordEntryMode = window.location.search.length === 0;

            const playContainerEl = withId("play-container");
            const cardContainerEl = withId("card-container");
            
            if (!wordEntryMode) {
                withId("word-form").className += " hidden";
                withId("check-button").addEventListener("click", () => {
                    currentCards.forEach(card => {
                        if (hashes.has(getCardHash(card))) {
                            card.classes[0] = "card correct";
                            rotate(card, 0);
                        } else {
                            card.classes[0] = "card wrong";
                            rotate(card, 0);
                        }
                    });
                });
                
                answers = queryParams.get("answers").split(",").map((answer, index) => {
                    const answerEl = el("div", answer, `answer answer-${index + 1}`);
                    cardContainerEl.appendChild(answerEl);
                    return {answer: answer, el: answerEl};
                });

                 queryParams.get("cards").split(",").forEach(card => {
                    const [cardIndex, hash] = card.split('|');
                    startingCards.push(cardIndex);
                    hashes.add(hash); 
                });

                if (hashes.size === 1) {
                    // invalid hashes from old url
                    withId("check-form").className += " hidden";
                }
            } else {
                withId("check-form").className += " hidden";
                playContainerEl.className += " word-entry";
            }

            const cardContainer = {
                el: cardContainerEl,
                classes: ["card-container"],
                rotation: 0,
                stylePrefix: "card-container"
            };

            const cardNum = Math.max(4, startingCards.length);
            const alreadySeen = new Set();
            for (let i = 1; i <= cardNum; ++i) {
                const card = {words: []};
                const cardEl = el("div", null, "card");

                let cardWords, index, startingIndex;
                if (!wordEntryMode) {
                    [index, startingIndex] = randomChoice(startingCards);
                    startingCards.splice(startingIndex, 1);
                    cardWords = cards[index];
                } else {
                    [cardWords, index] = randomCard(alreadySeen);
                    alreadySeen.add(index);
                }
                card.index = index;
                for (let j = 0; j < 4; ++j) {
                    const word = cardWords[j];
                    const wordEl = el("div", word, "word");
                    cardEl.appendChild(wordEl);
                    card.words.push({
                        word,
                        wordEl
                    });
                }

                let rotation = 0;
                rotation = randomChoice([0, 90, 180, 270])[0];

                const cardObj = {
                    card,
                    el: cardEl,
                    rotation: rotation,
                    classes: ["card"],
                    stylePrefix: `card-${i}`,
                    index,
                    listIndex: i - 1
                };
                if (i === 5) {
                    playContainerEl.appendChild(cardEl);
                } else {
                    cardContainerEl.appendChild(cardEl);
                }
                
                rotate(cardObj, 0);
                currentCards.push(cardObj);
            }

            const form = withId("word-form");

            function handleAnswer() {
                const formData = new FormData(form);
                const answer = formData.get("answer").trim();
                if (!answer) {
                    return;
                }
                const currentWord = (cardContainer.rotation % 360) / 90;
                let answerEl = answers[currentWord].el;
                if (answerEl) {
                    answerEl.innerText = answer;
                } else {
                    answerEl = el("div", answer, `answer answer-${currentWord + 1}`);
                }
                cardContainerEl.appendChild(answerEl);
                answers[currentWord] = {
                    answer,
                    el: answerEl
                };

                if (answers.every(obj => obj.answer)) {
                    resultsPopup(answers, currentCards);
                }
            }

            form.addEventListener("submit", function (event) {
                event.preventDefault();
                handleAnswer();
            });

            const overallSpinEl = el("button", "‚Ü∫", "spinner spin-button");
            overallSpinEl.addEventListener("click", () => {
                handleAnswer();
                rotate(cardContainer);
            });
            cardContainerEl.appendChild(overallSpinEl);

            let previousAngle = null;

            function getRotationOrigin() {
                const erect = overallSpinEl.getBoundingClientRect();
                const [x, y] = [erect.x + erect.width / 2, erect.y + erect.height / 2];
                return [x, y];
            }

            function getAngle(event) {
                const [originX, originY] = getRotationOrigin();
                rotation = Math.atan2(event.pageY - originY, 
                    event.pageX - originX) * 180 / Math.PI;
                return rotation;
            }

            if (wordEntryMode) {
                cardContainerEl.addEventListener("touchstart", function (event) {
                    previousAngle = getAngle(event.touches[0]);
                });

                cardContainerEl.addEventListener("touchmove", function (event) {
                    if (previousAngle === null) {
                        return;
                    }
                    const currentAngle = getAngle(event.touches[0]);
                    let delta = currentAngle - previousAngle;
                    if (Math.abs(delta) > 300) {
                        return;
                    }
                    rotate(cardContainer, delta);
                    previousAngle = currentAngle;
                });

                cardContainerEl.addEventListener("touchend", function (event) {
                    cardContainer.rotation = Math.round(cardContainer.rotation / 90) * 90;
                    rotate(cardContainer, 0);
                    previousAngle = null;
                });
            } else {
                function swap(selectedCard, card) {
                    rotate(selectedCard, 0);
                    rotate(card, 0);
                    const selectedCardEl = selectedCard.el;
                    const swapCardEl = card.el;
                    if (swapCardEl !== selectedCardEl) {
                        [currentCards[selectedCard.listIndex], currentCards[card.listIndex]] = [currentCards[card.listIndex], currentCards[selectedCard.listIndex]];
                        [selectedCard.listIndex, card.listIndex] = [card.listIndex, selectedCard.listIndex];
                        const selectedRect = selectedCardEl.getBoundingClientRect();
                        const swapRect = swapCardEl.getBoundingClientRect();
                        selectedCardEl.className += " animated";
                        selectedCardEl.style.top = `${swapRect.top - selectedRect.top}px`;
                        selectedCardEl.style.left = `${swapRect.left - selectedRect.left}px`;   
                        swapCardEl.className += " animated";
                        swapCardEl.style.top = `${selectedRect.top - swapRect.top}px`;
                        swapCardEl.style.left = `${selectedRect.left - swapRect.left}px`;
                        
                        setTimeout(() => {
                            if (card.listIndex === 4) {
                                playContainerEl.replaceChild(swapCardEl, selectedCardEl);
                                cardContainerEl.appendChild(selectedCardEl);
                                selectedCard.rotation -= cardContainer.rotation;
                                card.rotation += cardContainer.rotation;
                            }
                            if (selectedCard.listIndex === 4) {
                                card.rotation -= cardContainer.rotation;
                                selectedCard.rotation += cardContainer.rotation;
                                playContainerEl.replaceChild(selectedCardEl, swapCardEl);
                                cardContainerEl.appendChild(swapCardEl);
                            }
                            rotate(selectedCard, 0);
                            rotate(card, 0);
                            selectedCardEl.style.top = '0';
                            selectedCardEl.style.left = '0';
                            swapCardEl.style.top = '0';
                            swapCardEl.style.left = '0';
                        }, 500);
                    } else {
                        rotate(card);
                    }
                }

                /* ### DRAG AND DROP CODE ### */

                let selectedCard = null;

                function startDrag(event, card) {
                    event.preventDefault();
                    selectedCard = card
                }

                function endDrag(event, card) {
                    event.preventDefault();
                    swap(selectedCard, card);
                }

                /* ### LONG PRESS CODE ### */

                let startTime = null;
                let timerFunc = null;
                const LONG_PRESS_TIME = 300;

                const startPress = (event, card) => {
                    if (event.type === "touchstart") {
                        event.preventDefault();
                    }
                    startTime = Date.now();
                    timerFunc = window.setTimeout(() => {
                        card.el.className += " focused";
                        window.navigator.vibrate && window.navigator.vibrate(20);
                    }, LONG_PRESS_TIME);
                }

                const clearTimer = () => {
                    if (timerFunc) {
                            clearTimeout(timerFunc);
                            timerFunc = null;
                        }
                }

                const endPress = (event, card) => {
                    const endTime = Date.now();

                    if (selectedCard) {
                        clearTimer();
                        swap(selectedCard, card);
                        selectedCard = null;
                        return;
                    }
 
                    if ((endTime - startTime) > LONG_PRESS_TIME) {
                        selectedCard = card;
                        card.el.className += " focused";
                    } else {
                        selectedCard = null;
                        clearTimer();
                        rotate(card);
                    }
                }

                currentCards.forEach(card => {
                    card.el.addEventListener("touchstart", (ev) => startPress(ev, card));
                    card.el.addEventListener("touchend", (ev) => endPress(ev, card));

                    card.el.addEventListener("mousedown", (ev) => startPress(ev, card));
                    card.el.addEventListener("mouseup", (ev) => endPress(ev, card));
                });
            }
        </script>
    </body>
</html>